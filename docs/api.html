<!-- api.html -->
<!-- Documentation of the API displayed in the swagger -->

<h2>Fonctionnement</h2>

<p>
Cette API permet de s'interfacer √† l'application ma-cantine afin de r√©aliser les d√©marches administratives de cantines.

Les sch√©mas des mod√®les de donn√©es sont disponibles en bas de page. Vous y retrouverez notamment la liste des <b>champs du volet approvisionnement</b> (approDiagnostic).
</p>

<h2>Autorisation üîì</h2>

* Les endpoints avec un cadenas <b>ouvert</b> n√©cessitent une autorisation. Ils sont destin√©s aux gestionnaires de cantines.
* Les endpoints avec un cadenas <b>ferm√©</b> ne n√©cessitent pas d'autorisation (ex: canteenStatistics). Ils sont accessibles par tous.

<p>
L'API est prot√©g√© par le protocole d'autorisation OAuth2 (voir <a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/authorization-code-flow">documentation du procotole</a> et <a href="https://django-oauth-toolkit.readthedocs.io/en/latest/">documentation du package Django OAuth Toolkit Documentation</a>). Afin d'obtenir une autorisation, il faut :
<ol>
<li>Avoir un compte de d√©v sur la plateforme <i>ma cantine</i>. Quand vous <a href="https://ma-cantine-demo.cleverapps.io/creer-mon-compte" target="_blank">cr√©ez votre compte</a>, cocher le cas "Je suis une d√©veloppeuse ou un d√©veloppeur logiciel et j'ai besoin d'acc√©der aux APIs". Si vous avez d√©j√† un compte et vous voyez pas la page de documentation API, il vous faudra cocher ce cas sur la page <a href="https://ma-cantine-demo.cleverapps.io/mon-compte/profil" target="_blank">Mon compte</a></li>
<li>Avoir <a href="https://ma-cantine-demo.cleverapps.io/o/applications/" target="_blank">enregistr√© votre application</a> sur la plateforme ma-cantine. A ce stade, il vous faut sauvegarder le CLIENT_SECRET qui ne sera plus visible ensuite (seulement la version hash√©e le sera).</li>
<li>R√©cup√©rer le code d'autorisation dans l'url (voir exemple plus bas). Ce code √† une dur√©e de vie d'une minute.</li>
<li>Utiliser ce code d'autorisation pour n√©gocier et r√©cuperer un token d'autorisation.</li>
</ol>

Vous serez ensuite autoris√© √† utiliser l'API avec vos m√™mes droits utilisateur que sur la plateforme.
</p>

<h2>Tester</h2>
<p>
<b>‚ö†Ô∏è Important :</b> Les tests se font obligatoirement sur la plateforme de <a href="https://ma-cantine-demo.cleverapps.io/" target="_blank">d√©mo</a> (la suite de la doc r√©f√©rencera toujours l'instance de d√©mo). La plateforme de <a href="https://ma-cantine.agriculture.gouv.fr">prod</a> est r√©serv√©e aux donn√©es r√©elles.

Vous pouvez utiliser ce swagger pour tester l'API ici ou consulter un <a href="https://github.com/betagouv/ma-cantine-demo-integration">exemple d'application</a> en python.
</p>

<h3> Tester ici </h3>

<p>
<ol>
<li>Cr√©er une application (comme d√©crit au dessus) avec le URI de redirection de swagger : <i>https://ma-cantine-demo.cleverapps.io/swagger-ui/oauth2-redirect.html</i> (pensez √† changer l'URL pour la production)</li>
<li>Sauvegarder le secret</li>
<li>Ici, cliquez sur le bouton vert Authorize üîì, et suivez le protocole d'autorisation dans la partie <b>oauth2 (OAuth2, authorizationCode)</b> avec le client_id et client_secret de l'application que vous avez cr√©√©e. Cette √©tape va vous renvoyer vers une page 404 de l'application ma-cantine. C'est bon signe ! Vous pouvez alors r√©cup√©rer le code dans l'URL. </br>
<li>Renseigner le code r√©cup√©r√© depuis l'URL dans la fen√™tre Authorize üîì, partie <b>cookieAuth (apiKey)</b></li>
</ol>
</p>

<h2>Gestion des erreurs</h2>

<p>
<i>En cours de r√©daction</i>
</p>
