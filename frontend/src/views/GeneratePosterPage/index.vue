<template>
  <div id="content" class="text-left">
    <h1 class="font-weight-black my-6">
      Générez votre affiche
      <br />
      «&nbsp;information des convives&nbsp;»
    </h1>
    <p class="text-body-2">
      En remplissant ce formulaire, vous pourrez générer un PDF à afficher ou à envoyer par mail à vos convives pour les
      informer sur la part de produits de qualité et durables et de la part des produits issus de projets alimentaires
      territoriaux entrant dans la composition des repas servis dans votre restaurant. Cette information est obtenue à
      partir de vos données annuelles d’achat. Si ces données ne sont pas disponibles vous pouvez utiliser d’autres
      critères (nombre de composantes, volume des denrées…).
    </p>
    <router-link
      :to="{ name: 'KeyMeasurePage', params: { id: 'information-des-usagers' } }"
      class="text-decoration-underline primary--text text-body-2"
    >
      En savoir plus sur la mesure
    </router-link>

    <div v-if="isAuthenticated">
      <v-row class="px-4 mt-2" align="center">
        <v-col cols="12" sm="6" md="7" class="my-0 my-sm-4 pl-0">
          <v-autocomplete
            outlined
            hide-details
            :items="userCanteens"
            label="Choissisez la cantine"
            v-model="selectedCanteenId"
            item-text="name"
            item-value="id"
          ></v-autocomplete>
        </v-col>
        <v-col class="my-0 my-sm-4 px-0 px-sm-4 d-flex justify-space-between">
          <v-btn x-large color="primary" @click="submit" :disabled="!selectedCanteenId">
            Générer mon affiche
          </v-btn>
        </v-col>
        <v-spacer></v-spacer>
      </v-row>
      <v-row>
        <v-col cols="12" md="7" class="text-body-2 mb-2">
          Pour mettre à jour ces données, rendez-vous sur
          <router-link :to="{ name: 'ManagementPage' }" class="text-decoration-underline primary--text text-body-2">
            mes cantines
          </router-link>
          .
        </v-col>
      </v-row>
      <div id="poster-preview" class="mb-8">
        <CanteenPoster
          id="canteen-poster"
          :canteen="selectedCanteen"
          :diagnostic="currentDiagnostic"
          :previousDiagnostic="previousDiagnostic"
        />
      </div>
    </div>
    <div id="poster-form-page" v-else>
      <div id="poster-generation">
        <v-form ref="form" v-model="formIsValid" id="poster-form" @submit.prevent>
          <h2 class="mb-4">À propos de votre cantine</h2>
          <p>
            Je représente
            <label for="canteen-name">la cantine</label>
            <v-text-field
              id="canteen-name"
              v-model="form.canteen.name"
              placeholder="nom de l'établissement"
              hide-details="auto"
              :rules="[validators.required]"
              solo
              class="my-4"
            ></v-text-field>
            dans
            <label for="commune">la commune de</label>
            <v-autocomplete
              id="commune"
              v-model="form.canteen.city"
              placeholder="nom de la commune"
              :loading="loadingCommunes"
              :items="communes"
              :search-input.sync="search"
              auto-select-first
              cache-items
              hide-details="auto"
              :rules="[validators.required]"
              solo
              class="my-4"
            ></v-autocomplete>
          </p>
          <p>
            <label for="servings">Nous servons</label>
            <v-text-field
              id="servings"
              v-model.number="form.canteen.dailyMealCount"
              type="number"
              :rules="[validators.greaterThanZero]"
              placeholder="200"
              solo
              class="my-4"
              suffix="repas par jour"
              hide-details="auto"
            />
          </p>
          <h2 class="mb-4">À propos de vos achats</h2>
          <p>
            <label for="total">
              Sur l'année de 2020, les achats alimentaires (repas, collations et boissons) répresentent
            </label>
            <v-text-field
              id="total"
              v-model.number="form.diagnostic.valueTotalHt"
              type="number"
              :rules="[validators.greaterThanZero]"
              placeholder="15000"
              suffix="euros HT"
              solo
              class="my-4"
              hide-details="auto"
              validate-on-blur
            />
          </p>
          <p>
            Sur ce total,
            <v-text-field
              id="bio"
              v-model.number="form.diagnostic.valueBioHt"
              type="number"
              :rules="[validators.greaterThanZero]"
              placeholder="3000"
              suffix="euros HT"
              solo
              class="my-4"
              hide-details="auto"
              validate-on-blur
            />
            correspondaient à des
            <label for="bio">produits bio</label>
            ,
            <v-text-field
              id="sustainable"
              v-model.number="form.diagnostic.valueSustainableHt"
              type="number"
              :rules="[validators.greaterThanZero]"
              placeholder="2000"
              suffix="euros HT"
              solo
              class="my-4"
              hide-details="auto"
              validate-on-blur
            />
            correspondaient à des
            <label for="sustainable">produits de qualité et durables (hors bio)</label>
            et
            <v-text-field
              id="pat"
              v-model.number="form.diagnostic.valuePatHt"
              type="number"
              :rules="[validators.nonNegativeOrEmpty]"
              placeholder="1000"
              suffix="euros HT"
              solo
              class="my-4"
              hide-details="auto"
              validate-on-blur
            />
            correspondaient à des
            <label for="pat">produits dans le cadre de Projects Alimentaires Territoriaux</label>
            .
          </p>
          <v-btn x-large color="primary" @click="submit">Générer mon affiche</v-btn>
          <p class="mt-4 caption">
            Pour ajouter une photo à l'affiche et accéder à d'autres fonctionnalités,
            <a href="/creer-mon-compte">créez un compte</a>
          </p>
        </v-form>
        <div id="poster-preview" class="ml-8">
          <CanteenPoster v-bind="form" id="canteen-poster" />
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Constants from "@/constants"
import CanteenPoster from "./CanteenPoster"
import html2pdf from "html2pdf.js"
import validators from "@/validators"

const YEAR = 2020 // TODO: this should be dynamic, not hard-coded

// normalise "À fîrst" to "A FIRST"
function normaliseName(name) {
  return name
    .normalize("NFD")
    .replace(/\p{Diacritic}/gu, "")
    .toUpperCase()
}

export default {
  components: {
    CanteenPoster,
  },
  data() {
    return {
      form: {
        diagnostic: {},
        canteen: {},
      },
      communes: [],
      loadingCommunes: false,
      search: null,
      formIsValid: true,
      selectedCanteenId: undefined,
    }
  },
  computed: {
    validators() {
      return validators
    },
    userCanteens() {
      const canteens = this.$store.state.userCanteens
      return canteens.sort((a, b) => {
        return normaliseName(a.name) > normaliseName(b.name) ? 1 : 0
      })
    },
    userCanteen() {
      return this.userCanteens.length > 0 ? this.userCanteens[0] : {}
    },
    initialDiagnostic() {
      let diagnostics = this.isAuthenticated ? this.serverDiagnostics : this.localDiagnostics
      return diagnostics.find((x) => x.year === YEAR) || Object.assign({}, Constants.DefaultDiagnostics, { year: YEAR })
    },
    serverDiagnostics() {
      return this.userCanteen.diagnostics || []
    },
    localDiagnostics() {
      return this.$store.getters.getLocalDiagnostics()
    },
    isAuthenticated() {
      return !!this.$store.state.loggedUser
    },
    selectedCanteen() {
      return this.userCanteens.find((x) => x.id === this.selectedCanteenId) || {}
    },
    currentDiagnostic() {
      return this.selectedCanteen?.diagnostics?.find((x) => x.year === YEAR) || {}
    },
    previousDiagnostic() {
      return this.selectedCanteen?.diagnostics?.find((x) => x.year === YEAR - 1) || {}
    },
  },
  beforeMount() {
    this.form.diagnostic = JSON.parse(JSON.stringify(this.initialDiagnostic))
    this.form.canteen = JSON.parse(JSON.stringify(this.userCanteen)) || {}
    // initialise autocomplete options so existing city is seen as valid input and displayed
    if (this.form.canteen.city) {
      this.communes = [this.form.canteen.city]
    }
  },
  watch: {
    search(val) {
      return val && val !== this.form.canteen.city && this.queryCommunes(val)
    },
  },
  methods: {
    queryCommunes(val) {
      this.loadingCommunes = true
      const queryUrl = "https://api-adresse.data.gouv.fr/search/?q=" + val + "&type=municipality&autocomplete=1"
      return fetch(queryUrl)
        .then((response) => response.json())
        .then((response) => {
          const communes = response.features
          this.communes = communes.map((commune) => `${commune.properties.label}`)
          this.loadingCommunes = false
        })
        .catch((error) => {
          console.log(error)
        })
    },
    async submit() {
      if (!this.selectedCanteenId) {
        this.$refs.form.validate()
        if (!this.formIsValid) {
          this.$store.dispatch("notifyRequiredFieldsError")
          return
        }

        this.saveDiagnostic()
        this.saveCanteen()
      }

      // this fixes an issue where the beginning of the pdf is blank depending on the scroll position
      window.scrollTo({ top: 0 })

      if (this.$matomo) {
        this.$matomo.trackEvent("form", "submit", "poster-generator")
      }

      const htmlPoster = document.getElementById("canteen-poster")
      const canteenName = this.selectedCanteen.name || this.form.canteen.name
      const pdfOptions = {
        filename: `Affiche_convives_${canteenName.replaceAll(" ", "_")}_2020.pdf`,
        image: { type: "jpeg", quality: 1 },
        html2canvas: { scale: 2, dpi: 300, letterRendering: true },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
      }
      return html2pdf()
        .from(htmlPoster)
        .set(pdfOptions)
        .save()
    },
    saveDiagnostic() {
      if (this.isAuthenticated) {
        this.saveInServer()
      } else {
        this.saveInLocalStorage()
      }
    },
    saveInServer() {
      let saveOperation

      if (this.form.diagnostic.id) {
        saveOperation = this.$store.dispatch("updateDiagnostic", {
          canteenId: this.userCanteen.id,
          id: this.form.diagnostic.id,
          payload: this.form.diagnostic,
        })
      } else {
        saveOperation = this.$store.dispatch("createDiagnostic", {
          canteenId: this.userCanteen.id,
          payload: this.form.diagnostic,
        })
      }

      return saveOperation
    },
    saveInLocalStorage() {
      this.$store.dispatch("saveLocalStorageDiagnostic", this.form.diagnostic)
    },
    saveCanteen() {
      if (this.isAuthenticated) {
        return this.$store.dispatch("updateCanteen", {
          id: this.userCanteen.id,
          payload: this.form.canteen,
        })
      }
    },
  },
}
</script>

<style scoped lang="scss">
#content {
  width: 210mm;
}

#poster-form-page {
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 1500px !important;
  margin: auto;
}

#poster-generation {
  display: flex;
  margin-top: 50px;
  width: 1200px;
}

#poster-preview {
  width: 210mm;
  min-width: 210mm;
  height: 296mm;
  min-height: 296mm;
  border: 1px solid $ma-cantine-grey;
}

@media (max-width: 1200px) {
  #poster-generation {
    flex-direction: column;
    width: auto;
  }
}

@media (max-width: 210mm) {
  #content {
    width: 100%;
  }

  #poster-preview {
    display: none;
  }
}
</style>
